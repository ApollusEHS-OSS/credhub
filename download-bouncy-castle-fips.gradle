def getBouncyCastleFipsJarSHA256Checksums() {
    return [
            "bcpkix-fips-1.0.3.jar": "d23dfbc1f842e5a1a94967d2a5ead56f257b3d51b24c8996a834f291c782374d",
            "bc-fips-1.0.2.jar": "b4340d7a9cc0d3664d6c560e2fcee9c7da6e6ae314855923c758fa32fff5b94e",
    ]
}

def downloadJarCommand(bouncyCastleFipsJarFilenames) {
    def curlOperations = bouncyCastleFipsJarFilenames.collect { filename ->
        return "curl https://downloads.bouncycastle.org/fips-java/${filename} -o libs/${filename}"
    }

    def bouncyCastleFipsJarSHA256Checksums = getBouncyCastleFipsJarSHA256Checksums()

    def verifyChecksumOperations = bouncyCastleFipsJarFilenames.collect { filename ->
        return "[[ \"\$(sha256sum libs/${filename} | awk '{print \$1}')\" == '${bouncyCastleFipsJarSHA256Checksums[filename]}' ]]"
    }

    return [
            "bash",
            "-c",
            "set -e && "
                    + "mkdir -p libs && "
                    + curlOperations.join(" && ") + " && "
                    + verifyChecksumOperations.join(" && ")
    ]
}

task downloadBouncyCastleFips(type: Exec) {

    def bouncyCastleFipsJarFilenames = getBouncyCastleFipsJarSHA256Checksums().keySet()

    def jarsExist = bouncyCastleFipsJarFilenames.inject { prev, current ->
        return file("libs/${current}").exists() && prev != false
    }

    if (!jarsExist) {
        commandLine downloadJarCommand(bouncyCastleFipsJarFilenames)
    } else {
        commandLine "echo", "bouncy castle fips jars already exist, skipping download ðŸš¦"
    }
}


subprojects {
    tasks.matching {it != downloadBouncyCastleFips}.all {it.dependsOn downloadBouncyCastleFips}
}
